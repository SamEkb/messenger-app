# Canary Deployment для Messenger App

Canary deployment - это стратегия постепенного выпуска новой версии приложения, при которой небольшая часть трафика направляется на новую версию для тестирования, прежде чем полностью перейти на неё.

## Структура файлов

В директории `k8s/canary` содержатся манифесты и скрипты для реализации Canary deployment:

- `namespace.yaml` - определение namespace
- `*-service.yaml` - конфигурация сервисов для каждого микросервиса
- `*-v1-deployment.yaml` - манифесты для текущей версии (стабильной)
- `*-v2-deployment.yaml` - манифесты для новой версии (canary)
- `apply-canary.sh` - скрипт для полного переключения на новую версию
- `rollback-canary.sh` - скрипт для отката к старой версии
- `gradual-migration.sh` - скрипт для постепенного увеличения трафика на новую версию
- `deploy-to-k8s.sh` - скрипт для первоначального развертывания

## Принцип работы

1. Изначально развертываются обе версии: основная (v1) с 3 репликами и canary (v2) с 1 репликой
2. Kubernetes Service направляет трафик на поды с лейблом `app: <service-name>` (без учёта версии)
3. Таким образом, примерно 25% трафика идет на новую версию
4. Если новая версия стабильна, постепенно увеличивается количество её реплик и уменьшается количество реплик старой версии
5. В конечном итоге, все поды старой версии заменяются новыми

## Сценарии использования

### Первоначальное развертывание

```bash
bash k8s/canary/deploy-to-k8s.sh
```

### Постепенный переход на новую версию

```bash
bash k8s/canary/gradual-migration.sh
```

### Быстрое переключение на новую версию

```bash
bash k8s/canary/apply-canary.sh
```

### Откат к предыдущей версии при обнаружении проблем

```bash
bash k8s/canary/rollback-canary.sh
```

## Мониторинг

Для эффективного Canary развертывания рекомендуется мониторить:

1. Скорость ответа сервисов
2. Частоту ошибок 
3. Использование ресурсов

## Особенности реализации

- Оба deployments (v1 и v2) имеют общий лейбл `app: <service-name>`, что позволяет сервису направлять трафик на обе версии
- Лейбл `version: v1/v2` используется для различения версий в deployments
- Масштабирование происходит за счет изменения количества реплик каждой версии